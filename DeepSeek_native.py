import os
import time
import streamlit as st
from docx import Document
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from langchain_openai import ChatOpenAI
from openai import RateLimitError


def extract_docx_content(doc: Document, keywords: list = None) -> str:
    """
    ä»docxæ–‡ä»¶ä¸­æå–å†…å®¹ï¼Œå¯é€‰æŒ‰å…³é”®å­—ç­›é€‰
    
    Args:
        doc: Documentå¯¹è±¡
        keywords: ç­›é€‰å…³é”®å­—åˆ—è¡¨
        
    Returns:
        æå–çš„æ–‡æœ¬å†…å®¹
    """
    paragraphs = [para.text for para in doc.paragraphs]
    
    # å¦‚æœæœ‰å…³é”®å­—ç­›é€‰
    if keywords:
        filtered_paragraphs = [
            para for para in paragraphs
            if any(keyword.lower() in para.lower() for keyword in keywords)
        ]
        return "\n".join(filtered_paragraphs)
    
    return "\n".join(paragraphs)


def initialize_deepseek_chain(api_base: str, api_key: str, model: str):
    """
    åˆå§‹åŒ–DeepSeeké—®ç­”é“¾
    
    Args:
        api_base: APIåŸºç¡€URL
        api_key: APIå¯†é’¥
        model: æ¨¡å‹åç§°
        
    Returns:
        é—®ç­”é“¾å¯¹è±¡
    """

    prompt = ChatPromptTemplate.from_template("""
    ä½ æ˜¯ä¸€ä½æ‹¥æœ‰5å¹´ä»¥ä¸Šç»éªŒçš„ä¸“ä¸šæ‹›æ ‡æ–‡ä»¶åˆ†æä¸“å®¶ï¼Œè¯·ä»”ç»†é˜…è¯»ä»¥ä¸‹æ‹›æ ‡æ–‡ä»¶å†…å®¹ï¼Œå¹¶æä¾›ä¸€ä¸ªè¯¦ç»†ã€å‡†ç¡®ä¸”ç»“æ„åŒ–çš„åˆ†ææ€»ç»“ã€‚

    æ‹›æ ‡æ–‡ä»¶å†…å®¹ï¼š
    {document}
    
    è¯·æ ¹æ®ä¸Šè¿°æ‹›æ ‡æ–‡ä»¶å†…å®¹ï¼Œæä¾›ä»¥ä¸‹ä¿¡æ¯çš„è¯¦ç»†åˆ†æå’Œæ€»ç»“ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½éœ€è¦å…·ä½“ä¿¡æ¯ï¼Œä¸èƒ½åªå†™æ ‡é¢˜ï¼š
    
    1. é¡¹ç›®åŸºæœ¬ä¿¡æ¯
       - é¡¹ç›®åç§°ï¼šè¯¦ç»†å…¨ç§°ï¼ˆä¾‹å¦‚ï¼šå¤§å”æ±Ÿè¥¿æŠšå· 2Ã—1000MW ç…¤ç”µæ‰©å»ºé¡¹ç›®ä¸»ä½“æ–½å·¥ - ä¸€æ ‡æ®µï¼‰
       - é¡¹ç›®ç¼–å·ï¼šæ‹›æ ‡ç¼–å·æˆ–å‚è€ƒå·ï¼ˆä¾‹å¦‚ï¼šCWEME-202505JXFZ-S001ï¼‰
       - æ‹›æ ‡äººï¼šæ‹›æ ‡å•ä½å…¨ç§°åŠè”ç³»æ–¹å¼ï¼ˆä¾‹å¦‚ï¼šå¤§å”æŠšå·ç¬¬äºŒå‘ç”µæœ‰é™å…¬å¸ï¼‰
       - æ‹›æ ‡ä»£ç†æœºæ„ï¼šä»£ç†æœºæ„åç§°åŠè”ç³»æ–¹å¼ï¼ˆä¾‹å¦‚ï¼šåŒ—äº¬å›½ç”µå·¥ç¨‹æ‹›æ ‡æœ‰é™å…¬å¸ï¼‰
       - é¡¹ç›®å®¡æ‰¹æœºå…³ï¼šå®¡æ‰¹éƒ¨é—¨ï¼ˆå¦‚é€‚ç”¨ï¼Œæ–‡æ¡£ä¸­æœªæåŠæ—¶æ³¨æ˜ï¼‰
       - èµ„é‡‘æ¥æºï¼šé¡¹ç›®èµ„é‡‘æ„æˆåŠæ¥æºï¼ˆæ–‡æ¡£ä¸­æœªæåŠæ—¶æ³¨æ˜ï¼‰
       - å»ºè®¾åœ°ç‚¹ï¼šè¯¦ç»†çš„é¡¹ç›®å®æ–½åœ°ç‚¹ï¼ˆä¾‹å¦‚ï¼šæ±Ÿè¥¿çœæŠšå·å¸‚ä¸´å·åŒºé¹ç”°ä¹¡ã€é’æ³¥é•‡ï¼‰
       - å»ºè®¾è§„æ¨¡ï¼šé¡¹ç›®æ€»ä½“è§„æ¨¡ã€å®¹é‡ç­‰å…·ä½“æ•°æ®ï¼ˆä¾‹å¦‚ï¼š2000MWï¼Œ2Ã—1000MWï¼‰
       - è®¡åˆ’å·¥æœŸï¼šæ€»å·¥æœŸå’Œå…³é”®èŠ‚ç‚¹å·¥æœŸï¼ˆä¾‹å¦‚ï¼šæ€»å·¥æœŸ955å¤©ï¼Œä»2025å¹´6æœˆ20æ—¥è‡³2028å¹´1æœˆ31æ—¥ï¼›3å·æœºç»„æŠ•äº§æ—¶é—´2027å¹´7æœˆ30æ—¥ï¼‰
       - æˆæ ‡åŸåˆ™ï¼šæ ‡æ®µåˆ’åˆ†å’Œä¸­æ ‡è§„åˆ™ï¼ˆä¾‹å¦‚ï¼šå…±2ä¸ªæ ‡æ®µï¼ŒæŠ•æ ‡äººæœ€å¤šä¸­æ ‡1ä¸ªæ ‡æ®µï¼›è‹¥2ä¸ªæ ‡æ®µå‡æ’åç¬¬ä¸€ï¼Œä¼˜å…ˆæˆäºˆä¸€æ ‡æ®µï¼‰
    
    2. é¡¹ç›®æ¦‚å†µ
       - é¡¹ç›®è§„æ¨¡ï¼šå…·ä½“æ•°æ®å¦‚è£…æœºå®¹é‡ã€å•ä½æ•°é‡ï¼ˆä¾‹å¦‚ï¼š2Ã—1000MWæœºç»„ï¼‰
       - å»ºè®¾åœ°ç‚¹ï¼šè¯¦ç»†åœ°å€ï¼ˆä¾‹å¦‚ï¼šæ±Ÿè¥¿çœæŠšå·å¸‚ä¸´å·åŒºé¹ç”°ä¹¡ã€é’æ³¥é•‡ï¼‰
       - è®¡åˆ’å·¥æœŸï¼šå¼€å§‹å’Œç»“æŸæ—¥æœŸï¼Œå…³é”®é‡Œç¨‹ç¢‘ï¼ˆä¾‹å¦‚ï¼šæ€»å·¥æœŸ955å¤©ï¼Œ3å·æœºç»„æ–½å·¥770å¤©ï¼‰
       - è´¨é‡æ ‡å‡†ï¼šè´¨é‡éªŒæ”¶æ ‡å‡†å’Œè¦æ±‚ï¼ˆæ–‡æ¡£ä¸­æœªæåŠæ—¶æ³¨æ˜ï¼‰
       - æ ‡æ®µåˆ’åˆ†ï¼šæ ‡æ®µæ•°é‡ã€å„æ ‡æ®µèŒƒå›´ï¼ˆä¾‹å¦‚ï¼šä¸€æ ‡æ®µä¸º3å·æœºç»„åŠéƒ¨åˆ†å…¬ç”¨ç³»ç»Ÿï¼‰
    
    3. æ‹›æ ‡èŒƒå›´
       - å…·ä½“æ‹›æ ‡å†…å®¹ï¼šè¯¦ç»†åˆ—å‡ºæ‰€æœ‰æ¶‰åŠçš„ç³»ç»Ÿã€å·¥ç¨‹å†…å®¹ï¼ˆä¾‹å¦‚ï¼šçƒ­åŠ›ã€ç‡ƒæ–™ä¾›åº”ã€é™¤ç°ã€æ°´å¤„ç†ã€ä¾›æ°´ã€ç”µæ°”ã€çƒ­å·¥æ§åˆ¶ã€è„±ç¡«ã€è„±ç¡ç­‰ç³»ç»Ÿï¼›ç‰©èµ„åº“æˆ¿å»ºè®¾ï¼›è®¾å¤‡ä»£ä¿ç®¡ï¼›è°ƒè¯•å·¥ä½œç­‰ï¼‰
       - ä¸»è¦å·¥ä½œé‡ï¼šå„é¡¹å·¥ä½œçš„è§„æ¨¡æˆ–æ•°é‡ï¼ˆä»¥å·¥ç¨‹é‡æ¸…å•ä¸ºå‡†ï¼Œæ–‡æ¡£ä¸­æœªè¯¦ç»†åˆ—æ˜æ—¶æ³¨æ˜ï¼‰
       - æŠ€æœ¯æ ‡å‡†ï¼šé‡‡ç”¨çš„æŠ€æœ¯è§„èŒƒå’Œæ ‡å‡†ï¼ˆæ–‡æ¡£ä¸­æœªæåŠæ—¶æ³¨æ˜ï¼‰
       - äº¤ä»˜è¦æ±‚ï¼šæˆæœäº¤ä»˜å½¢å¼ã€æ—¶é—´ã€åœ°ç‚¹ï¼ˆä¾‹å¦‚ï¼šä¾æ®æ‹›æ ‡æ–‡ä»¶è¦æ±‚ï¼Œé…åˆè°ƒè¯•ç­‰ï¼‰
       - è°ƒè¯•è¦æ±‚ï¼šå•ä½“è°ƒè¯•ã€åˆ†ç³»ç»Ÿè°ƒè¯•ã€æ•´å¥—å¯åŠ¨è°ƒè¯•ç­‰å…·ä½“å®‰æ’
    
    4. æŠ•æ ‡äººèµ„æ ¼è¦æ±‚
       - èµ„è´¨æ¡ä»¶ï¼šæ‰€éœ€èµ„è´¨ç­‰çº§å’Œç±»åˆ«ï¼ˆä¾‹å¦‚ï¼šç”µåŠ›å·¥ç¨‹æ–½å·¥æ€»æ‰¿åŒ…ä¸€çº§èµ„è´¨ã€å®‰å…¨ç”Ÿäº§è®¸å¯è¯ã€æ‰¿è£…ä¸€çº§+æ‰¿è¯•ä¸€çº§ç”µåŠ›è®¾æ–½è®¸å¯è¯ï¼‰
       - è´¢åŠ¡è¦æ±‚ï¼šè´¢åŠ¡çŠ¶å†µè‰¯å¥½ï¼ˆä¾‹å¦‚ï¼šæœªå¤„äºåœäº§ã€ç ´äº§çŠ¶æ€ï¼Œèµ„äº§æœªè¢«é‡ç»„ã€æ¥ç®¡ç­‰ï¼‰
       - ä¸šç»©è¦æ±‚ï¼šè¿‘5å¹´ç±»ä¼¼é¡¹ç›®ä¸šç»©æ•°é‡å’Œè§„æ¨¡ï¼ˆä¾‹å¦‚ï¼š2ä¸ªåŠä»¥ä¸Š1000MWç«ç”µæœºç»„ä¸»ä½“æ–½å·¥å·²ç«£å·¥ä¸šç»©ï¼‰
       - é¡¹ç›®ç»ç†è¦æ±‚ï¼šèµ„è´¨ã€æ³¨å†Œå»ºé€ å¸ˆã€å®‰å…¨ç”Ÿäº§è€ƒæ ¸è¯ã€æ— åœ¨å»ºé¡¹ç›®ç­‰ï¼ˆä¾‹å¦‚ï¼šä¸€çº§æ³¨å†Œå»ºé€ å¸ˆã€å®‰å…¨ç”Ÿäº§è€ƒæ ¸Bè¯ã€è¿‘5å¹´1ä¸ªåŠä»¥ä¸Š1000MWæœºç»„ä¸šç»©ï¼‰
       - å…¶ä»–è¦æ±‚ï¼šæ˜¯å¦æ¥å—è”åˆä½“æŠ•æ ‡ã€è¯æ˜ææ–™è¦æ±‚ç­‰ï¼ˆä¾‹å¦‚ï¼šä¸æ¥å—è”åˆä½“ï¼›éœ€æä¾›åˆåŒã€ç«£å·¥éªŒæ”¶è¯æ˜ç­‰ï¼‰
       - å¦å†³é¡¹ï¼šå¯èƒ½å¯¼è‡´æŠ•æ ‡è¢«å¦å†³çš„æƒ…å½¢ï¼ˆä¾‹å¦‚ï¼šè¢«åˆ—å…¥ä¸¥é‡å¤±ä¿¡ä¸»ä½“åå•ã€å¤§å”é›†å›¢â€œç°åå•â€â€œé»‘åå•â€ï¼‰
    
    5. æ‹›æ ‡æ–‡ä»¶è·å–
       - è·å–æ—¶é—´ï¼šå…·ä½“æ—¥æœŸå’Œæ—¶é—´èŒƒå›´ï¼ˆä¾‹å¦‚ï¼š2025å¹´5æœˆ7æ—¥è‡³5æœˆ21æ—¥17:00ï¼‰
       - è·å–æ–¹å¼ï¼šå¹³å°ç½‘å€ã€éœ€CAè¯ä¹¦ç­‰ï¼ˆä¾‹å¦‚ï¼šå¤§å”ç”µå­å•†åŠ¡å¹³å°ï¼Œéœ€ä¼ä¸šCAè¯ä¹¦ä¸‹è½½ï¼‰
       - æ–‡ä»¶å”®ä»·ï¼šè´¹ç”¨åŠå‘ç¥¨ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼šå”®ä»·è¯¦è§å¹³å°æç¤ºï¼Œç”µå­å‘ç¥¨å‘é€ï¼‰
    
    6. æŠ•æ ‡æ–‡ä»¶é€’äº¤
       - æˆªæ­¢æ—¶é—´ï¼šå…·ä½“æ—¥æœŸå’Œæ—¶é—´ï¼ˆä¾‹å¦‚ï¼š2025å¹´5æœˆ28æ—¥09:00ï¼‰
       - é€’äº¤æ–¹å¼ï¼šç”µå­å¹³å°ã€æ–‡ä»¶å¤§å°é™åˆ¶ç­‰ï¼ˆä¾‹å¦‚ï¼šå¤§å”ç”µå­å•†åŠ¡å¹³å°ï¼Œæ€»å¤§å°â‰¤800Mï¼Œå•ä¸ªæ–‡ä»¶â‰¤100Mï¼‰
       - é€’äº¤åœ°å€ï¼šå¹³å°è¯¦æƒ…ï¼ˆä¾‹å¦‚ï¼šé€šè¿‡å¹³å°ç”µå­é€’äº¤ï¼‰
       - ä¿è¯é‡‘ï¼šæŠ•æ ‡ä¿è¯é‡‘é‡‘é¢åŠç¼´çº³æ–¹å¼ï¼ˆæ–‡æ¡£ä¸­æœªæåŠæ—¶æ³¨æ˜ï¼‰
       - æ–‡ä»¶è¦æ±‚ï¼šå•†åŠ¡ã€æŠ€æœ¯ã€ä»·æ ¼æ–‡ä»¶çš„å¤§å°ã€æ•°é‡ã€ç­¾å­—ç›–ç« è¦æ±‚ï¼ˆä¾‹å¦‚ï¼šæ€»æ•°é‡â‰¤20ä¸ªï¼Œéƒ¨åˆ†æ–‡ä»¶éœ€ç­¾å­—ç›–ç« ï¼‰
    
    7. è¯„æ ‡æ–¹æ³•å’Œæ ‡å‡†
       - è¯„æ ‡æ–¹æ³•ï¼šå¦‚ç»¼åˆè¯„ä¼°æ³•ï¼ˆä¾‹å¦‚ï¼šå•†åŠ¡10%+æŠ€æœ¯50%+æŠ¥ä»·40%ï¼‰
       - è¯„åˆ†æ ‡å‡†ï¼šå„éƒ¨åˆ†æƒé‡ã€ç»†åˆ†é¡¹åˆ†å€¼ï¼ˆä¾‹å¦‚ï¼šå•†åŠ¡éƒ¨åˆ†å«ä¼ä¸šå®åŠ›ã€è´¢åŠ¡çŠ¶å†µï¼›æŠ€æœ¯éƒ¨åˆ†å«æ–½å·¥ç»„ç»‡è®¾è®¡ï¼›æŠ¥ä»·éƒ¨åˆ†æŒ‰åå·®æ‰“åˆ†ï¼‰
       - åºŸæ ‡æ¡ä»¶ï¼šå…·ä½“æƒ…å½¢ï¼ˆä¾‹å¦‚ï¼šèµ„æ ¼åå®¡æœªé€šè¿‡ã€æ–‡ä»¶ä¸ç¬¦åˆè¦æ±‚ç­‰ï¼‰
       - è¯„æ ‡å§”å‘˜ä¼šï¼šç»„æˆæ–¹å¼ï¼ˆä¾‹å¦‚ï¼š5äººä»¥ä¸Šå•æ•°ï¼Œæ‹›æ ‡äººä»£è¡¨â‰¤1/3ï¼Œä¸“å®¶éšæœºæŠ½å–ï¼‰
    
    8. åˆåŒæ¡æ¬¾è¦ç‚¹
       - åˆåŒå½¢å¼ï¼šç±»å‹å’Œæ ¼å¼ï¼ˆä¾‹å¦‚ï¼šä¾æ®æ‹›æ ‡æ–‡ä»¶å’ŒæŠ•æ ‡æ–‡ä»¶ç­¾è®¢ä¹¦é¢åˆåŒï¼‰
       - æ”¯ä»˜æ–¹å¼ï¼šé¢„ä»˜æ¬¾ã€è¿›åº¦æ¬¾ã€ç«£å·¥ç»“ç®—ã€è´¨é‡ä¿è¯é‡‘ç­‰è¯¦ç»†æ¡ä»¶ï¼ˆä¾‹å¦‚ï¼šé¢„ä»˜æ¬¾10%ï¼Œè¿›åº¦æ¬¾æŒ‰æœˆæ”¯ä»˜85%ï¼Œç«£å·¥ç»“ç®—æ”¯ä»˜è‡³97%ï¼‰
       - å±¥çº¦æ‹…ä¿ï¼šé‡‘é¢ã€æäº¤æ—¶é—´ã€å½¢å¼ï¼ˆä¾‹å¦‚ï¼šåˆåŒé‡‘é¢10%ï¼Œç­¾è®¢åˆåŒå‰14å¤©å†…æäº¤ï¼‰
       - è¿çº¦è´£ä»»ï¼šä¸»è¦è¿çº¦æ¡æ¬¾å’Œå¤„ç½šï¼ˆä¾‹å¦‚ï¼šé€¾æœŸæ”¯ä»˜æŒ‰ä¸­å›½äººæ°‘é“¶è¡ŒåŸºå‡†åˆ©ç‡è®¡è¿çº¦é‡‘ï¼‰
       - æœ€ç»ˆç»“æ¸…ï¼šç¼ºé™·è´£ä»»æœŸåçš„æ”¯ä»˜å®‰æ’ï¼ˆä¾‹å¦‚ï¼šç¼ºé™·è´£ä»»æœŸ12ä¸ªæœˆï¼ŒæœŸæ»¡å14å¤©å†…é€€è¿˜ä¿è¯é‡‘ï¼‰
    
    9. å…¶ä»–é‡è¦ä¿¡æ¯
       - è¸å‹˜ç°åœºï¼šå®‰æ’ï¼ˆæ–‡æ¡£ä¸­æœªæåŠæ—¶æ³¨æ˜ï¼‰
       - ç­”ç–‘å®‰æ’ï¼šæ—¶é—´åŠæ–¹å¼ï¼ˆæ–‡æ¡£ä¸­æœªæåŠæ—¶æ³¨æ˜ï¼‰
       - åˆ†åŒ…è¦æ±‚ï¼šæ˜¯å¦å…è®¸åˆ†åŒ…ï¼ˆæ–‡æ¡£ä¸­æœªæåŠæ—¶æ³¨æ˜ï¼‰
       - åå·®è¯´æ˜ï¼šæ˜¯å¦å…è®¸åå·®ï¼ˆæ–‡æ¡£ä¸­æœªæåŠæ—¶æ³¨æ˜ï¼‰
       - å¼‚è®®ä¸æŠ•è¯‰ï¼šæå‡ºæ—¶é—´ã€æ¸ é“ï¼ˆä¾‹å¦‚ï¼šå¯¹æ‹›æ ‡æ–‡ä»¶å¼‚è®®éœ€åœ¨æŠ•æ ‡æˆªæ­¢å‰10æ—¥æå‡ºï¼›æŠ•è¯‰å¯é€šè¿‡å¹³å°æˆ–ç”µè¯ï¼‰
       - ç”µå­æ‹›æ ‡æŠ•æ ‡ï¼šå¹³å°ä½¿ç”¨ã€è´¹ç”¨æ‰¿æ‹…ï¼ˆä¾‹å¦‚ï¼šå…¨ç¨‹ç”µå­åŒ–ï¼ŒæŠ•æ ‡äººæ‰¿æ‹…æŠ•æ ‡è´¹ç”¨ï¼Œä¸­æ ‡äººæ‰¿æ‹…ä»£ç†æœåŠ¡è´¹ï¼‰
       - é‡æ–°æ‹›æ ‡ä¸ä¸å†æ‹›æ ‡æƒ…å½¢ï¼šå…·ä½“æ¡ä»¶ï¼ˆä¾‹å¦‚ï¼šæŠ•æ ‡äººä¸è¶³3ä¸ªæˆ–æ‰€æœ‰æŠ•æ ‡è¢«å¦å†³æ—¶å¯é‡æ–°æ‹›æ ‡ï¼‰
    
    è¦æ±‚ï¼š
    1. ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°ç»“æ„å’Œé¡ºåºè¿›è¡Œç»„ç»‡
    2. æ¯ä¸ªéƒ¨åˆ†éƒ½è¦æœ‰å…·ä½“å†…å®¹ï¼Œä¸èƒ½åªå†™æ ‡é¢˜
    3. ä¿¡æ¯è¦å‡†ç¡®ï¼Œç›´æ¥æ¥æºäºæ‹›æ ‡æ–‡ä»¶å†…å®¹
    4. å¦‚æŸéƒ¨åˆ†å†…å®¹åœ¨æ‹›æ ‡æ–‡ä»¶ä¸­æœªæåŠï¼Œè¯·æ³¨æ˜â€œæ–‡æ¡£ä¸­æœªæåŠâ€
    5. ä½¿ç”¨æ¸…æ™°çš„åˆ†æ®µå’Œåˆ—è¡¨å½¢å¼å±•ç¤ºä¿¡æ¯
    6. ä¿æŒä¸“ä¸šã€ä¸¥è°¨çš„åˆ†æé£æ ¼
    """)

    llm = ChatOpenAI(
        openai_api_base=api_base,
        openai_api_key=api_key,
        model=model,
    )

    return prompt | llm | StrOutputParser()


def docx_qa(doc: Document, qa_chain, keywords: list = None) -> str:
    """
    å¯¹docxæ–‡ä»¶å†…å®¹è¿›è¡Œé—®ç­”
    
    Args:
        doc: Documentå¯¹è±¡
        qa_chain: é—®ç­”é“¾å¯¹è±¡
        keywords: ç­›é€‰å…³é”®å­—åˆ—è¡¨
        
    Returns:
        æ¨¡å‹å›ç­”ç»“æœ
    """
    # æå–å†…å®¹ï¼ˆå¯èƒ½ç»è¿‡ç­›é€‰ï¼‰
    document_content = extract_docx_content(doc, keywords)
    
    # æ·»åŠ é‡è¯•æœºåˆ¶
    max_retries = 3
    retry_delay = 60  # é‡è¯•ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰
    
    for attempt in range(max_retries):
        try:
            response = qa_chain.invoke({
                "document": document_content
            })
            return response
        except RateLimitError as e:
            st.warning(f"è§¦å‘é€Ÿç‡é™åˆ¶ï¼ˆç¬¬{attempt + 1}æ¬¡ï¼‰: {str(e)}")
            if attempt < max_retries - 1:  # ä¸æ˜¯æœ€åä¸€æ¬¡å°è¯•
                st.info(f"ç­‰å¾…{retry_delay}ç§’åé‡è¯•...")
                time.sleep(retry_delay)
            else:
                st.error("å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ— æ³•å®Œæˆè¯·æ±‚")
                raise e
        except Exception as e:
            error_msg = str(e)
            if "Insufficient Balance" in error_msg or "402" in error_msg:
                st.error("âŒ é”™è¯¯ï¼šèµ„æºä¸è¶³ï¼")
                st.info("ğŸ’¡ æç¤ºï¼šè¯·è¡¥å……èµ„æºåé‡è¯•ï¼ã€‚")
                raise e
            else:
                st.error(f"å‘ç”Ÿå…¶ä»–é”™è¯¯: {error_msg}")
                raise e


def main():
    """ä¸»å‡½æ•°ï¼Œè¿è¡ŒStreamlitåº”ç”¨ç¨‹åº"""
    st.set_page_config(page_title="æ‹›æ ‡æ–‡ä»¶æ™ºèƒ½åˆ†æå·¥å…·", layout="wide")
    
    st.title("ğŸ“„ æ‹›æ ‡æ–‡ä»¶æ™ºèƒ½åˆ†æå·¥å…·")
    st.caption("ä¸Šä¼ æ‹›æ ‡æ–‡ä»¶ï¼Œè¿›è¡Œæ™ºèƒ½åˆ†æå’Œæ€»ç»“")
    
       # --- Sidebar: æå–é€‰é¡¹ ---
    with st.sidebar:
        st.header("âš™ï¸ æå–é€‰é¡¹")
        use_keyword_filter = st.checkbox("å¯ç”¨å…³é”®å­—ç­›é€‰", value=False)
        
        if use_keyword_filter:
            keywords_input = st.text_area("è¾“å…¥å…³é”®å­—ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰", 
                                        "æ‹›æ ‡\næŠ•æ ‡\né¡¹ç›®\nèµ„æ ¼\næŠ•æ ‡æ–‡ä»¶\næˆªæ­¢æ—¶é—´\nè¯„æ ‡")
            keywords_list = [kw.strip() for kw in keywords_input.split('\n') if kw.strip()]
        else:
            keywords_list = None

    # --- Main: æ–‡ä»¶ä¸Šä¼ ä¸åˆ†æ ---
    uploaded_file = st.file_uploader("ä¸Šä¼ æ‹›æ ‡æ–‡ä»¶", type=["docx"])

    # ç›´æ¥åœ¨ä»£ç ä¸­é…ç½®APIå‚æ•°ï¼ˆè¯·æ›¿æ¢ä¸ºæ‚¨çš„å®é™…å¯†é’¥ï¼‰
    API_BASE = "https://api.deepseek.com/v1"
    API_KEY = "sk-4e9badbed59143cc94b6b8951c5941fa"  # âš ï¸ è¯·åœ¨æ­¤å¤„å¡«å…¥æ‚¨çš„çœŸå®APIå¯†é’¥
    MODEL = "deepseek-chat"

    if uploaded_file:
        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        st.info(f"å·²ä¸Šä¼ æ–‡ä»¶: {uploaded_file.name}")
        
        # åŠ è½½docxæ–‡æ¡£
        try:
            doc = Document(uploaded_file)
            st.success("æ–‡ä»¶åŠ è½½æˆåŠŸ")
        except Exception as e:
            st.error(f"æ–‡ä»¶åŠ è½½å¤±è´¥: {e}")
            st.stop()
        
        # åˆå§‹åŒ–é—®ç­”é“¾
        try:
            qa_chain = initialize_deepseek_chain(api_base=API_BASE, api_key=API_KEY, model=MODEL)
            # st.success("æ¨¡å‹è¿æ¥æˆåŠŸ")
        except Exception as e:
            st.error(f"æ¨¡å‹åˆå§‹åŒ–å¤±è´¥: {e}")
            st.stop()
        
        # å¼€å§‹åˆ†ææŒ‰é’®
        if st.button("ğŸ” å¼€å§‹åˆ†æ", type="primary"):
            with st.spinner("æ­£åœ¨åˆ†ææ‹›æ ‡æ–‡ä»¶ï¼Œè¯·ç¨å€™..."):
                start_time = time.time()
                try:
                    # è°ƒç”¨æ¨¡å‹è¿›è¡Œåˆ†æ
                    summary = docx_qa(doc, qa_chain, keywords=keywords_list)
                    elapsed_time = time.time() - start_time
                    
                    # æ˜¾ç¤ºç»“æœ
                    st.success(f"åˆ†æå®Œæˆï¼Œè€—æ—¶: {elapsed_time:.2f} ç§’")
                    st.markdown("## ğŸ“Š åˆ†æç»“æœ")
                    st.markdown(summary)
                    
                except Exception as e:
                    st.error(f"åˆ†æè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")
    else:
        st.info("è¯·ä¸Šä¼ ä¸€ä¸ª.docxæ ¼å¼çš„æ‹›æ ‡æ–‡ä»¶")


if __name__ == "__main__":
    main()
